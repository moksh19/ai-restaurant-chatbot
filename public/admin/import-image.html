<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Import Menu From Image</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-100">
<div class="max-w-3xl mx-auto bg-white shadow mt-10 p-6 rounded">
  <h1 class="text-2xl font-bold mb-6">Import Menu From Image / Screenshot</h1>

  <label class="block font-semibold mb-1">Restaurant ID</label>
  <input id="restaurantId"
         type="text"
         class="w-full border p-2 rounded mb-4"
         placeholder="pizza-pints" />

  <label class="block font-semibold mb-1">Menu Image (JPG/PNG)</label>
  <input id="menuImage"
         type="file"
         accept="image/*"
         class="w-full border p-2 rounded mb-4" />

  <!-- Import Mode -->
  <div class="mb-4">
    <label class="block font-semibold mb-1">Import Mode</label>

    <label class="flex items-center gap-2 mb-1">
      <input type="radio" name="importMode" value="merge" checked />
      <span>Merge with existing menu (default)</span>
    </label>

    <label class="flex items-center gap-2">
      <input type="radio" name="importMode" value="replace" />
      <span>Replace entire menu</span>
    </label>
  </div>

  <button onclick="importFromImage()"
          class="w-full bg-blue-600 text-white p-3 rounded mb-4">
    Import From Image
  </button>

  <pre id="output" class="w-full bg-gray-50 border p-4 rounded h-64 overflow-auto text-sm"></pre>

  <button id="saveBtn" onclick="saveImportedMenu()"
          class="w-full bg-green-600 text-white p-3 rounded mt-4 hidden">
    Save to Restaurant
  </button>

  <a href="/admin/index.html" class="block text-blue-700 mt-4 underline">
    Back to Dashboard
  </a>
</div>

<script>
let importedMenu = null;

function prefillRestaurantId() {
  const params = new URLSearchParams(window.location.search);
  const id = params.get("id");
  if (id) {
    document.getElementById("restaurantId").value = id;
  }
}

async function importFromImage() {
  const restaurantId = document.getElementById("restaurantId").value;
  const fileInput = document.getElementById("menuImage");
  const file = fileInput.files[0];

  if (!restaurantId || !file) {
    document.getElementById("output").textContent =
      "Error: restaurantId and an image file are required";
    return;
  }

  const formData = new FormData();
  formData.append("restaurantId", restaurantId);
  formData.append("image", file);

  const res = await fetch("/import-from-image", {
    method: "POST",
    body: formData
  });

  const data = await res.json();

  if (data.error) {
    document.getElementById("output").textContent = "Error: " + data.error;
    document.getElementById("saveBtn").classList.add("hidden");
    return;
  }

  importedMenu = data.menu;
  document.getElementById("output").textContent =
    JSON.stringify(importedMenu, null, 2);
  document.getElementById("saveBtn").classList.remove("hidden");
}

async function saveImportedMenu() {
  const restaurantId = document.getElementById("restaurantId").value;

  if (!importedMenu) {
    alert("No imported menu available.");
    return;
  }

  const mode = document.querySelector('input[name="importMode"]:checked').value;

  if (mode === "replace") {
    const sure = confirm(
      "This will REPLACE the existing menu for this restaurant. Continue?"
    );
    if (!sure) return;
  }

  const payload = { menu: importedMenu };
  if (mode === "replace") {
    payload.replace = true;
  }

  const res = await fetch(`/restaurants/${encodeURIComponent(restaurantId)}`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(payload)
  });

  if (res.ok) {
    alert("Menu imported and saved successfully!");
  } else {
    alert("Error saving the imported menu.");
  }
}

prefillRestaurantId();
</script>

</body>
</html>
