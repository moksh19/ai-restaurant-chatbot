<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>Import Menu From Image</title>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body class="bg-gray-100">
    <div class="max-w-3xl mx-auto bg-white shadow mt-8 p-6 rounded">
      <h1 class="text-2xl font-bold mb-2">Import Menu From Image / PDF</h1>
      <div id="restaurantInfo" class="text-sm text-gray-600 mb-4">
        Loading restaurant...
      </div>

      <div class="mb-4 border rounded p-4 bg-slate-50">
        <h2 class="font-semibold mb-2">Upload Image or PDF Screenshot</h2>
        <p class="text-xs text-gray-600 mb-2">
          Upload a clear picture or PDF screenshot of the menu.
          The AI will try to extract categories, items, prices and notes.
        </p>

        <input
          id="imageFile"
          type="file"
          accept="image/*,.pdf"
          class="mb-3 text-sm"
        />

        <div class="mt-3 flex items-center gap-3">
          <button
            id="btnImport"
            class="bg-orange-700 text-white px-4 py-2 rounded text-sm"
          >
            Import Menu
          </button>
          <span id="importStatus" class="text-xs text-gray-600"></span>
        </div>
      </div>

      <div class="mb-4">
        <h2 class="font-semibold mb-2">Imported Menu Preview</h2>
        <pre
          id="menuPreview"
          class="border rounded bg-slate-50 p-3 text-xs overflow-x-auto min-h-[80px]"
        ></pre>
      </div>

      <div class="mb-4 flex items-center gap-2">
        <input
          id="replaceMenu"
          type="checkbox"
          class="h-4 w-4"
        />
        <label for="replaceMenu" class="text-sm">
          Replace existing menu instead of merging
        </label>
      </div>

      <div class="flex gap-3 items-center">
        <button
          id="btnSave"
          class="bg-blue-600 text-white px-4 py-2 rounded text-sm disabled:opacity-50"
          disabled
        >
          Save Menu to Restaurant
        </button>
        <a href="/admin/index.html" class="text-blue-600 underline text-sm">
          Back to Dashboard
        </a>
        <span id="saveStatus" class="text-xs text-gray-600"></span>
      </div>
    </div>

    <script>
      const params = new URLSearchParams(window.location.search);
      const restaurantId = params.get("id");

      const infoEl = document.getElementById("restaurantInfo");
      const importStatusEl = document.getElementById("importStatus");
      const previewEl = document.getElementById("menuPreview");
      const saveBtn = document.getElementById("btnSave");
      const saveStatusEl = document.getElementById("saveStatus");

      let importedMenu = [];

      if (!restaurantId) {
        document.body.innerHTML =
          '<div class="max-w-xl mx-auto mt-10 text-red-600 font-semibold">Missing ?id= in URL.</div>';
      } else {
        infoEl.textContent = "Restaurant ID: " + restaurantId;
        loadRestaurantName();
      }

      async function loadRestaurantName() {
        try {
          const res = await fetch("/restaurants");
          if (!res.ok) return;
          const all = await res.json();
          const r = all.find((x) => x.id === restaurantId);
          if (r) {
            infoEl.textContent =
              (r.name || "Restaurant") + " (ID: " + restaurantId + ")";
          }
        } catch (e) {
          console.warn("Could not load restaurant name", e);
        }
      }

      async function importFromImage() {
        const input = document.getElementById("imageFile");
        if (!input.files || !input.files[0]) {
          alert("Please choose an image or PDF file.");
          return;
        }

        importStatusEl.textContent = "Importing menu from image...";
        previewEl.textContent = "";
        saveBtn.disabled = true;
        saveStatusEl.textContent = "";
        importedMenu = [];

        const form = new FormData();
        form.append("image", input.files[0]);
        form.append("restaurantId", restaurantId);

        try {
          const res = await fetch("/import-from-image", {
            method: "POST",
            body: form,
          });
          const data = await res.json();
          if (!res.ok || !Array.isArray(data.menu)) {
            throw new Error(data.error || "Image import failed");
          }

          importedMenu = data.menu;
          importStatusEl.textContent =
            "Imported " + importedMenu.length + " category(ies). Review below.";
          previewEl.textContent = JSON.stringify(importedMenu, null, 2);
          saveBtn.disabled = false;
        } catch (err) {
          console.error("Image menu import error:", err);
          importStatusEl.textContent = "Error importing menu from image.";
          previewEl.textContent = "";
          saveBtn.disabled = true;
        }
      }

      async function saveMenu() {
        if (!importedMenu || importedMenu.length === 0) {
          alert("No imported menu to save.");
          return;
        }

        const replace = document.getElementById("replaceMenu").checked;

        saveStatusEl.textContent = "Saving menu...";
        saveBtn.disabled = true;

        try {
          const res = await fetch("/restaurants/" + restaurantId, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              menu: importedMenu,
              replace,
            }),
          });
          const data = await res.json();
          if (!res.ok) {
            throw new Error(data.error || "Save failed");
          }
          saveStatusEl.textContent = replace
            ? "Saved. Existing menu was replaced."
            : "Saved. Imported menu was merged with existing.";

          saveBtn.disabled = false;
        } catch (err) {
          console.error("Save image-menu error:", err);
          saveStatusEl.textContent = "Error saving menu.";
          saveBtn.disabled = false;
        }
      }

      document
        .getElementById("btnImport")
        .addEventListener("click", (e) => {
          e.preventDefault();
          importFromImage();
        });

      saveBtn.addEventListener("click", (e) => {
        e.preventDefault();
        saveMenu();
      });
    </script>
  </body>
</html>
