<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>Import Offers From Website</title>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body class="bg-gray-100">
    <div class="max-w-3xl mx-auto bg-white shadow mt-8 p-6 rounded">
      <h1 class="text-2xl font-bold mb-2">Import Offers From Website</h1>
      <div id="restaurantInfo" class="text-sm text-gray-600 mb-4">
        Loading restaurant...
      </div>

      <div class="mb-4 border rounded p-4 bg-slate-50">
        <h2 class="font-semibold mb-2">Website URL</h2>
        <p class="text-xs text-gray-600 mb-2">
          Enter a page that lists your promotions / daily specials / deals.
          For example: your homepage, "specials" page, or online ordering
          offers page.
        </p>

        <label class="block text-sm font-medium mb-1">Offers Page URL</label>
        <input
          id="offersUrl"
          type="text"
          class="border rounded w-full p-2 text-sm mb-3"
          placeholder="https://thepizzapints.com/specials"
        />

        <div class="mt-3 flex items-center gap-3">
          <button
            id="btnImport"
            class="bg-cyan-700 text-white px-4 py-2 rounded text-sm"
          >
            Import Offers
          </button>
          <span id="importStatus" class="text-xs text-gray-600"></span>
        </div>
      </div>

      <div class="mb-4">
        <h2 class="font-semibold mb-2">Imported Offers Preview</h2>
        <p class="text-xs text-gray-500 mb-2">
          Review before saving. You can edit them later in
          <strong>Edit Offers</strong>.
        </p>
        <pre
          id="offersPreview"
          class="border rounded bg-slate-50 p-3 text-xs overflow-x-auto min-h-[80px]"
        ></pre>
      </div>

      <div class="mb-4 flex items-center gap-2">
        <input
          id="replaceOffers"
          type="checkbox"
          class="h-4 w-4"
        />
        <label for="replaceOffers" class="text-sm">
          Replace existing offers instead of appending
        </label>
      </div>

      <div class="flex gap-3 items-center">
        <button
          id="btnSave"
          class="bg-emerald-600 text-white px-4 py-2 rounded text-sm disabled:opacity-50"
          disabled
        >
          Save Offers to Restaurant
        </button>
        <a href="/admin/index.html" class="text-blue-600 underline text-sm">
          Back to Dashboard
        </a>
        <span id="saveStatus" class="text-xs text-gray-600"></span>
      </div>
    </div>

    <script>
      const params = new URLSearchParams(window.location.search);
      const restaurantId = params.get("id");

      const infoEl = document.getElementById("restaurantInfo");
      const importStatusEl = document.getElementById("importStatus");
      const previewEl = document.getElementById("offersPreview");
      const saveBtn = document.getElementById("btnSave");
      const saveStatusEl = document.getElementById("saveStatus");

      let importedOffers = [];

      if (!restaurantId) {
        document.body.innerHTML =
          '<div class="max-w-xl mx-auto mt-10 text-red-600 font-semibold">Missing ?id= in URL.</div>';
      } else {
        infoEl.textContent = "Restaurant ID: " + restaurantId;
        loadRestaurantName();
      }

      async function loadRestaurantName() {
        try {
          const res = await fetch("/restaurants");
          if (!res.ok) return;
          const all = await res.json();
          const r = all.find((x) => x.id === restaurantId);
          if (r) {
            infoEl.textContent =
              (r.name || "Restaurant") + " (ID: " + restaurantId + ")";
          }
        } catch (e) {
          console.warn("Could not load restaurant name", e);
        }
      }

      async function importFromWebsite() {
        const url = document.getElementById("offersUrl").value.trim();

        if (!url) {
          alert("Please enter a website URL.");
          return;
        }

        importStatusEl.textContent = "Importing offers from website...";
        previewEl.textContent = "";
        saveBtn.disabled = true;
        saveStatusEl.textContent = "";
        importedOffers = [];

        try {
          const res = await fetch("/import-offers-from-url", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ restaurantId, url }),
          });

          const data = await res.json();
          if (!res.ok) {
            throw new Error(data.error || "Import failed");
          }

          if (!Array.isArray(data.offers) || data.offers.length === 0) {
            importStatusEl.textContent =
              "No offers detected. Check the page content and try again.";
            previewEl.textContent = "";
            return;
          }

          importedOffers = data.offers;
          importStatusEl.textContent =
            "Imported " + importedOffers.length + " offer(s). Review below.";
          previewEl.textContent = JSON.stringify(importedOffers, null, 2);
          saveBtn.disabled = false;
        } catch (err) {
          console.error("Website offers import error:", err);
          importStatusEl.textContent = "Error importing offers.";
          previewEl.textContent = "";
          saveBtn.disabled = true;
        }
      }

      async function saveOffers() {
        if (!importedOffers || importedOffers.length === 0) {
          alert("No imported offers to save.");
          return;
        }

        const replace = document.getElementById("replaceOffers").checked;

        saveStatusEl.textContent = "Saving offers...";
        saveBtn.disabled = true;

        try {
          const res = await fetch("/restaurants/" + restaurantId, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              offers: importedOffers,
              replaceOffers: replace,
            }),
          });

          const data = await res.json();
          if (!res.ok) {
            throw new Error(data.error || "Save failed");
          }

          saveStatusEl.textContent = replace
            ? "Saved. Existing offers were replaced."
            : "Saved. Imported offers were appended.";

          saveBtn.disabled = false;
        } catch (err) {
          console.error("Save offers error:", err);
          saveStatusEl.textContent = "Error saving offers.";
          saveBtn.disabled = false;
        }
      }

      document
        .getElementById("btnImport")
        .addEventListener("click", (e) => {
          e.preventDefault();
          importFromWebsite();
        });

      saveBtn.addEventListener("click", (e) => {
        e.preventDefault();
        saveOffers();
      });
    </script>
  </body>
</html>
