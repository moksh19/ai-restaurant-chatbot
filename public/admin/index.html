<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>Restaurant Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body class="bg-gray-100">
    <div class="max-w-5xl mx-auto mt-8">
      <!-- Header -->
      <div class="flex justify-between items-center mb-6">
        <h1 class="text-3xl font-bold">Restaurant Dashboard</h1>
        <div class="flex gap-3">
          <a
            href="/admin/add.html"
            class="bg-blue-600 text-white px-4 py-2 rounded shadow text-sm flex items-center gap-2"
          >
            <span class="text-xl leading-none">+</span>
            Add Restaurant
          </a>
          <button
            id="btnBackup"
            class="bg-slate-800 text-white px-4 py-2 rounded shadow text-sm"
          >
            Download Backup (JSON)
          </button>
        </div>
      </div>

      <h2 class="text-xl font-semibold mb-3">Current Restaurants</h2>
      <div id="restaurantList" class="space-y-4"></div>

      <div
        id="globalError"
        class="mt-4 text-sm text-red-600 hidden"
      ></div>
    </div>

    <script>
      async function loadRestaurants() {
        const list = document.getElementById("restaurantList");
        const errorBox = document.getElementById("globalError");
        errorBox.classList.add("hidden");
        errorBox.textContent = "";

        try {
          const res = await fetch("/restaurants");
          if (!res.ok) {
            throw new Error("Failed to load restaurants");
          }
          const data = await res.json();

          if (!Array.isArray(data) || data.length === 0) {
            list.innerHTML =
              '<div class="text-gray-500 text-sm">No restaurants yet. Click "Add Restaurant" to create one.</div>';
            return;
          }

          list.innerHTML = "";
          data.forEach((r) => {
            const card = document.createElement("div");
            card.className =
              "bg-white shadow rounded p-4 border border-slate-200";

            const id = r.id || "";
            const name = r.name || id || "(Unnamed)";

            card.innerHTML = `
              <div class="flex justify-between items-center mb-2">
                <div>
                  <div class="font-semibold text-lg">${name}</div>
                  <div class="text-xs text-gray-500">ID: ${id}</div>
                </div>
              </div>

              <div class="flex flex-wrap gap-3 text-sm mb-4">
                <a href="/admin/basic.html?id=${encodeURIComponent(
                  id
                )}" class="text-blue-600 hover:underline">Edit Basic</a>
                <a href="/admin/menu.html?id=${encodeURIComponent(
                  id
                )}" class="text-green-700 hover:underline">Edit Menu</a>
                <a href="/admin/offers.html?id=${encodeURIComponent(
                  id
                )}" class="text-purple-700 hover:underline">Edit Offers</a>

                <a href="/admin/import-image.html?id=${encodeURIComponent(
                  id
                )}" class="text-orange-700 hover:underline">Import Menu From Image</a>

                <a href="/admin/import.html?id=${encodeURIComponent(
                  id
                )}" class="text-emerald-700 hover:underline">Import Menu From URL</a>

                <a href="/admin/import-offers-url.html?id=${encodeURIComponent(
                  id
                )}" class="text-cyan-700 hover:underline">Import Offers From Website</a>

                <a href="/admin/import-instagram.html?id=${encodeURIComponent(
                  id
                )}" class="text-pink-700 hover:underline">Import Offers From Instagram</a>
              </div>

              <details class="bg-slate-50 rounded border px-3 py-2 text-xs">
                <summary class="cursor-pointer font-semibold mb-1">
                  Embed snippet for this restaurant
                </summary>
                <p class="text-[11px] text-gray-600 mb-1">
                  Paste this snippet into any website where you want the chat widget to appear.
                </p>
                <pre class="embed-snippet whitespace-pre-wrap text-[11px] bg-white border rounded p-2 overflow-x-auto"></pre>
              </details>
            `;

            // Build the embed snippet safely (avoid closing this script tag)
            const snippet = `
<script
  src="https://ai-restaurant-chatbot.onrender.com/widget.js?v=3"
  data-restaurant-id="${id}"
  data-backend-url="https://ai-restaurant-chatbot.onrender.com"
><\\/script>`.trim();

            const pre = card.querySelector(".embed-snippet");
            pre.textContent = snippet;

            list.appendChild(card);
          });
        } catch (err) {
          console.error("Error loading restaurants:", err);
          list.innerHTML = "";
          errorBox.textContent = "Error loading restaurants";
          errorBox.classList.remove("hidden");
        }
      }

      document
        .getElementById("btnBackup")
        .addEventListener("click", () => {
          window.location.href = "/admin/backup";
        });

      loadRestaurants();
    </script>
  </body>
</html>
